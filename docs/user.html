<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="Imagenes/Logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="css/style_user.css">
    <script src="https://kit.fontawesome.com/a5dcd729dd.js" crossorigin="anonymous"></script>
    <title>SafeWave: User Profile</title>
</head>
<body>
    <header>
        <div class="logo"><a href="index.html"><img src="Imagenes/Logo.png" alt="SafeWave Logo" /></a>SafeWave</div>
        <nav>
            <a href="index.html" class="active">Home</a>
            <a href="about-us.html">About us</a>
            <a href="Courses.html">Courses</a>
            <a href="gallery.html">Gallery</a>
            <a href="Contact.html">Contact</a>
        </nav>
        <div class="header-right">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search..." />
                üîç
            </div>
            <a id="user-btn" href="L-R.html" class="user-btn" title="Register">
                <i class="fa-solid fa-user"></i>
            </a>
        </div>
    </header>

    <div class="container">
        <div class="header">
            <div class="profile-photo-container">
                <img src="https://via.placeholder.com/120x120/4facfe/ffffff?text=Usuario" alt="" class="profile-photo" id="profilePhoto">
                <div class="photo-overlay" onclick="document.getElementById('fileInput').click()">
                    <span>Change<br>Photo</span>
                </div>
            </div>
            <div class="photo-actions">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    üì∑ Upload Photo
                </button>
                <button class="btn btn-danger" onclick="removePhoto()">
                    üóëÔ∏è Delete Photo
                </button>
            </div>
            <div class="user-info">
                <div class="user-uid" id="userUID">UID: Loading...</div>
                <div class="user-email" id="userEmail">Loading email...</div>
            </div>
            <input type="file" id="fileInput" accept="image/*" onchange="handlePhotoUpload(event)">
        </div>

        <div class="content">
            <div class="section">
                <h2 class="section-title">
                    üë§ Account Details
                </h2>
                <div class="account-details">
                    <div class="detail-item">
                        <span class="detail-label">Registration Date</span>
                        <span class="detail-value" id="registrationDate">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Courses in Progress</span>
                        <span class="stat-badge" id="coursesInProgress">0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Completed Courses</span>
                        <span class="stat-badge" id="coursesCompleted">0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Progress</span>
                        <span class="detail-value" id="totalProgress">0%</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">
                    üìö Course Progress
                </h2>
                <div id="coursesContainer">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Loading Courses...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-storage-compat.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCdX5PRjQzb-k_Arm6a9bkxdxm_ykMzmiI",
            authDomain: "safewave-2025.firebaseapp.com",
            projectId: "safewave-2025",
            storageBucket: "safewave-2025.firebasestorage.app",
            messagingSenderId: "319373701223",
            appId: "1:319373701223:web:4e9c853d3b534ed7b0e4c2",
            measurementId: "G-JR5ZH0G6H7"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null;
        let userData = {
            email: '',
            registrationDate: '',
            profilePhoto: null,
            courses: []
        };

        function formatDate(dateString) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return new Date(dateString).toLocaleDateString('es-ES', options);
        }

        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file || !currentUser) return;

            try {
                const photoRef = storage.ref(`profile_photos/${currentUser.uid}`);
                const uploadTask = await photoRef.put(file);
                const downloadURL = await uploadTask.ref.getDownloadURL();

                document.getElementById('profilePhoto').src = downloadURL;

                await db.collection('users').doc(currentUser.uid).update({
                    profilePhoto: downloadURL
                });

                userData.profilePhoto = downloadURL;

            } catch (error) {
                console.error('Error subiendo foto:', error);
            }
        }

        async function removePhoto() {
            if (!currentUser) return;

            try {
                if (userData.profilePhoto) {
                    const photoRef = storage.ref(`profile_photos/${currentUser.uid}`);
                    await photoRef.delete().catch(() => {});
                }

                await db.collection('users').doc(currentUser.uid).update({
                    profilePhoto: null
                });

                document.getElementById('profilePhoto').src = 'https://via.placeholder.com/120x120/4facfe/ffffff?text=Usuario';
                userData.profilePhoto = null;

            } catch (error) {
                console.error('Error eliminando foto:', error);
            }
        }

        function renderCourses() {
            const container = document.getElementById('coursesContainer');
            const coursesInProgress = userData.courses.filter(c => c.status === 'progress').length;
            const coursesCompleted = userData.courses.filter(c => c.status === 'completed').length;
            
            document.getElementById('coursesInProgress').textContent = coursesInProgress;
            document.getElementById('coursesCompleted').textContent = coursesCompleted;
            document.getElementById('registrationDate').textContent = formatDate(userData.registrationDate);
            
            const totalProgress = userData.courses.length > 0 ? Math.round(
                userData.courses.reduce((sum, course) => sum + course.progress, 0) / userData.courses.length
            ) : 0;
            document.getElementById('totalProgress').textContent = `${totalProgress}%`;
            
            if (userData.courses.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>No hay cursos registrados a√∫n.</p>
                    </div>
                `;
            } else {
                container.innerHTML = userData.courses.map(course => `
                    <div class="course-item">
                        <div class="course-header">
                            <span class="course-name">${course.name}</span>
                            <span class="course-status ${course.status === 'completed' ? 'status-completed' : 'status-progress'}">
                                ${course.status === 'completed' ? '‚úÖ Completado' : 'üìö En Progreso'}
                            </span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar ${course.status === 'completed' ? 'completed' : ''}" 
                                 style="width: ${course.progress}%">
                            </div>
                        </div>
                        <div class="progress-text">${course.progress}% completado</div>
                    </div>
                `).join('');
            }
        }

        async function loadUserData(user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const data = userDoc.data();
                    userData = {
                        email: user.email,
                        registrationDate: data.registrationDate || user.metadata.creationTime,
                        profilePhoto: data.profilePhoto || null,
                        courses: data.courses || []
                    };
                } else {
                    userData = {
                        email: user.email,
                        registrationDate: new Date().toISOString(),
                        profilePhoto: null,
                        courses: []
                    };

                    await db.collection('users').doc(user.uid).set(userData);
                }

                document.getElementById('userUID').textContent = `UID: ${user.uid}`;
                document.getElementById('userEmail').textContent = userData.email;

                if (userData.profilePhoto) {
                    document.getElementById('profilePhoto').src = userData.profilePhoto;
                }

                renderCourses();

            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        auth.onAuthStateChanged(function(user) {
            if (user) {
                currentUser = user;
                loadUserData(user);
            } else {
                window.location.href = 'L-R.html';
            }
        });
    </script>
</body>
</html>